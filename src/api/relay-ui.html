<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>DelayRelay OBS Dock</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<style>
			:root {
				--bg: #181a1b;
				--fg: #e0e0e0;
				--accent: #3399ff;
				--danger: #e74c3c;
				--success: #27ae60;
				--input-bg: #23272e;
				--input-fg: #e0e0e0;
				--input-border: #444;
				--button-bg: #23272e;
				--button-fg: #e0e0e0;
				--button-border: #444;
				--button-hover-bg: #2d3a4a;
				--button-hover-fg: #fff;
				--button-hover-border: #3399ff;
			}
			html,
			body {
				background: var(--bg);
				color: var(--fg);
				font-family: system-ui, sans-serif;
				margin: 0;
				padding: 0;
				min-width: 220px;
				min-height: 180px;
				font-size: 15px;
			}
			.container {
				padding: 1em 1.2em 0.5em 1.2em;
				display: flex;
				flex-direction: column;
				gap: 1em;
			}
			.status-row {
				display: flex;
				align-items: center;
				gap: 0.7em;
				flex-wrap: wrap;
			}
			.icon {
				width: 1.3em;
				height: 1.3em;
				vertical-align: middle;
				display: inline-block;
			}
			.status-dot {
				width: 0.9em;
				height: 0.9em;
				border-radius: 50%;
				display: inline-block;
				margin-right: 0.3em;
				background: var(--danger);
			}
			.status-dot.active {
				background: var(--success);
			}
			.label {
				font-size: 0.98em;
				opacity: 0.7;
				margin-right: 0.3em;
			}
			.delay-edit {
				display: flex;
				align-items: center;
				gap: 0.3em;
			}
			input[type='number'] {
				width: 4em;
				background: var(--input-bg);
				color: var(--input-fg);
				border: 1.5px solid var(--input-border);
				border-radius: 4px;
				padding: 0.2em 0.5em;
				font-size: 1em;
			}
			button {
				background: var(--button-bg);
				color: var(--button-fg);
				border: 1px solid var(--button-border);
				border-radius: 4px;
				padding: 0.3em 0.8em;
				cursor: pointer;
				font-size: 1em;
				transition: background 0.2s, color 0.2s, border 0.2s;
				display: flex;
				align-items: center;
				gap: 0.3em;
			}
			button:hover,
			button:focus-visible {
				background: var(--button-hover-bg);
				color: var(--button-hover-fg);
				border: 1.5px solid var(--button-hover-border);
				outline: none;
			}
			.result {
				background: #23272e;
				color: #e0e0e0;
				border-radius: 4px;
				padding: 0.7em;
				margin-top: 0.5em;
				font-size: 0.97em;
				min-height: 1.2em;
				word-break: break-all;
			}
			.spacer {
				flex: 1;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="status-row">
				<span class="label">Server</span>
				<span id="server-dot" class="status-dot"></span>
				<span id="server-status">...</span>
				<button id="toggle-server" title="Start/Stop Server">
					<span id="server-icon" class="icon">&#x23F5;</span>
				</button>
			</div>
			<div class="status-row">
				<span class="label">Delay</span>
				<span id="delay-dot" class="status-dot"></span>
				<span id="delay-status">...</span>
				<button id="toggle-delay" title="Activate/Deactivate Delay">
					<span id="delay-icon" class="icon">&#x23F8;</span>
				</button>
			</div>
			<div class="status-row">
				<span class="label">Delay (s)</span>
				<div class="delay-edit">
					<input id="delay-ms" type="number" min="1" step="1" placeholder="..." />
					<button id="set-delay" title="Set Delay">
						<span class="icon">&#x2714;</span>
					</button>
				</div>
			</div>
			<div class="status-row">
				<span class="label">Connection</span>
				<span id="conn-dot" class="status-dot"></span>
				<span id="conn-status">...</span>
			</div>
			<div class="result" id="result"></div>
		</div>
		<script>
			function fetchStatus() {
				return fetch('/status').then(r => r.json());
			}
			function setStatusUI(data) {
				// Server
				const serverDot = document.getElementById('server-dot');
				const serverStatus = document.getElementById('server-status');
				const serverIcon = document.getElementById('server-icon');
				if (data.serverRunning) {
					serverDot.classList.add('active');
					serverStatus.textContent = 'Running';
					serverIcon.textContent = '\u23F9'; // Stop icon
				} else {
					serverDot.classList.remove('active');
					serverStatus.textContent = 'Stopped';
					serverIcon.textContent = '\u23F5'; // Play icon
				}
				// Delay
				const delayDot = document.getElementById('delay-dot');
				const delayStatus = document.getElementById('delay-status');
				const delayIcon = document.getElementById('delay-icon');
				if (data.STATE === 'DELAY' || data.STATE === 'REWIND') {
					delayDot.classList.add('active');
					delayStatus.textContent = 'Active';
					delayIcon.textContent = '\u23F8'; // Pause icon
				} else {
					delayDot.classList.remove('active');
					delayStatus.textContent = 'Inactive';
					delayIcon.textContent = '\u25B6'; // Play icon
				}
				// Delay ms
				const delayInput = document.getElementById('delay-ms');
				delayInput.value = Math.round((data.STREAM_DELAY_MS || 0) / 1000);
				delayInput.disabled = data.STATE !== 'REALTIME';
				document.getElementById('set-delay').disabled = delayInput.disabled;
				// Connection (dummy for now)
				const connDot = document.getElementById('conn-dot');
				const connStatus = document.getElementById('conn-status');
				// You can update this with real connection info if available
				connDot.classList.add('active');
				connStatus.textContent = 'OK';
			}
			function showResult(msg) {
				document.getElementById('result').textContent = msg;
			}
			function updateAll() {
				fetchStatus().then(data => setStatusUI(data));
			}
			document.getElementById('toggle-server').onclick = function () {
				fetchStatus().then(data => {
					const endpoint = data.serverRunning ? '/stop-server' : '/start-server';
					fetch(endpoint).then(() => updateAll());
				});
			};
			document.getElementById('toggle-delay').onclick = function () {
				fetchStatus().then(data => {
					const endpoint = data.STATE === 'DELAY' || data.STATE === 'REWIND' ? '/deactivate-delay' : '/activate-delay';
					fetch(endpoint).then(() => updateAll());
				});
			};
			document.getElementById('set-delay').onclick = function () {
				const val = document.getElementById('delay-ms').value;
				if (!val || isNaN(val) || val < 1) {
					showResult('Invalid delay value.');
					return;
				}
				fetch(`/set-delay?ms=${parseInt(val, 10) * 1000}`)
					.then(() => updateAll())
					.catch(() => showResult('Failed to set delay.'));
			};
			// Initial load and periodic refresh
			updateAll();
			setInterval(updateAll, 3000);
		</script>
	</body>
</html>
